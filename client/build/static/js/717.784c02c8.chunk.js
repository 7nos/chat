"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[717],{505:(e,t,n)=>{n.d(t,{DA:()=>p,E_:()=>a,Mk:()=>g,OW:()=>d,Pt:()=>u,QM:()=>m,_z:()=>l,al:()=>f,bW:()=>h,kv:()=>i,qR:()=>c});var o=n(722);const r=(()=>{const e={NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_BACKEND_PORT||5001,t=window.location.hostname,n="https:"===window.location.protocol?"https:":"http:",o="localhost"===t||"127.0.0.1"===t?"localhost":t;return"".concat(n,"//").concat(o,":").concat(e,"/api")})();console.log("API Base URL:",r);const s=o.A.create({baseURL:r});s.interceptors.request.use((e=>{const t=localStorage.getItem("userId");if(t)e.headers["x-user-id"]=t;else if(!e.url.includes("/auth/"))return console.warn("API Interceptor: userId not found in localStorage for non-auth request to",e.url),window.location.href="/login?sessionExpired=true",Promise.reject(new Error("User ID not found. Please log in."));return e.data instanceof FormData?delete e.headers["Content-Type"]:e.headers["Content-Type"]||(e.headers["Content-Type"]="application/json"),e}),(e=>(console.error("API Request Interceptor Error:",e),Promise.reject(e)))),s.interceptors.response.use((e=>e),(e=>(e.response&&401===e.response.status&&(console.warn("API Response Interceptor: Received 401 Unauthorized. Clearing auth data and redirecting to login."),localStorage.removeItem("sessionId"),localStorage.removeItem("username"),localStorage.removeItem("userId"),window.location.pathname.includes("/login")||(window.location.href="/login?sessionExpired=true")),Promise.reject(e))));const a=e=>s.post("/auth/signup",e),i=e=>s.post("/auth/signin",e),l=async(e,t,n,s)=>{try{return(await o.A.post("".concat(r,"/api/chat/send"),{message:e,sessionId:t,messageHistory:n,llmPreference:s})).data}catch(a){throw console.error("Error sending message:",a),a}},c=e=>s.post("/chat/history",e),d=()=>s.get("/chat/sessions"),u=e=>s.get("/chat/session/".concat(e)),m=e=>s.post("/upload",e),p=()=>s.get("/files"),g=(e,t)=>s.patch("/files/".concat(e),{newOriginalName:t}),h=e=>s.delete("/files/".concat(e)),f=e=>s.post("/api/user/preferences/llm",{preference:e})},717:(e,t,n)=>{n.r(t),n.d(t,{default:()=>S});var o=n(43),r=n(216),s=n(505),a=n(263),i=n(285),l=n(238),c=n(579);const d=[{id:"friendly",title:"Friendly Tutor",prompt:"You are a friendly, patient, and encouraging tutor specializing in engineering and scientific topics for PhD students. Explain concepts clearly, break down complex ideas, use analogies, and offer positive reinforcement. Ask follow-up questions to ensure understanding."},{id:"explorer",title:"Concept Explorer",prompt:"You are an expert academic lecturer introducing a new, complex engineering or scientific concept. Your goal is to provide a deep, structured explanation. Define terms rigorously, outline the theory, provide relevant mathematical formulations (using Markdown), illustrative examples, and discuss applications or limitations pertinent to PhD-level research."},{id:"knowledge_check",title:"Knowledge Check",prompt:"You are assessing understanding of engineering/scientific topics. Ask targeted questions to test knowledge, identify misconceptions, and provide feedback on the answers. Start by asking the user what topic they want to be quizzed on."},{id:"custom",title:"Custom Prompt",prompt:""}],u=e=>{const t=d.find((t=>t.id===e));return t?t.prompt:""},m="system-prompt-widget-styles";if(!document.getElementById(m)){const e=document.createElement("style");e.id=m,e.type="text/css",e.innerText='\n/* client/src/components/SystemPromptWidget.css */\n.system-prompt-widget { padding: 20px; background-color: var(--bg-header); box-sizing: border-box; display: flex; flex-direction: column; flex-shrink: 0; }\n.system-prompt-widget h3 { margin-top: 0; margin-bottom: 15px; color: var(--text-primary); font-size: 1rem; font-weight: 600; padding-bottom: 10px; }\n.prompt-select { width: 100%; padding: 10px 12px; margin-bottom: 15px; background-color: #2a2a30; color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; cursor: pointer; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url(\'data:image/svg+xml;utf8,<svg fill="%23b0b3b8" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>\'); background-repeat: no-repeat; background-position: right 10px center; background-size: 18px; }\n.prompt-select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(0, 132, 255, 0.3); }\n.prompt-label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; }\n.prompt-textarea { width: 100%; background-color: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 12px; font-size: 0.85rem; line-height: 1.5; box-sizing: border-box; font-family: inherit; resize: none; height: 100px; overflow-y: auto; }\n.prompt-textarea:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 2px rgba(0, 132, 255, 0.3); }\n.prompt-textarea::placeholder { color: var(--text-secondary); opacity: 0.7; }\n.char-count { text-align: right; font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; }\n',document.head.appendChild(e)}const p=e=>{let{selectedPromptId:t,promptText:n,onSelectChange:o,onTextChange:r}=e;return(0,c.jsxs)("div",{className:"system-prompt-widget",children:[(0,c.jsx)("h3",{children:"Assistant Mode"}),(0,c.jsxs)("select",{className:"prompt-select",value:t,onChange:e=>{const t=e.target.value;o(t)},"aria-label":"Select Assistant Mode",children:[d.filter((e=>"custom"!==e.id)).map((e=>(0,c.jsx)("option",{value:e.id,children:e.title},e.id))),"custom"===t&&(0,c.jsx)("option",{value:"custom",children:"Custom Prompt"},"custom")]}),(0,c.jsx)("label",{htmlFor:"system-prompt-text",className:"prompt-label",children:"System Prompt (Editable)"}),(0,c.jsx)("textarea",{id:"system-prompt-text",className:"prompt-textarea",value:n,onChange:e=>{r(e.target.value)},rows:"5",maxLength:"2000",placeholder:"The current system prompt will appear here. You can edit it directly.","aria-label":"Editable System Prompt Text"})]})},g=e=>{let{isOpen:t,onClose:n}=e;const[r,i]=(0,o.useState)([]),[l,d]=(0,o.useState)(null),[u,m]=(0,o.useState)(!1),[p,g]=(0,o.useState)(!1),[h,f]=(0,o.useState)("");(0,o.useEffect)((()=>{if(t){(async()=>{if(!localStorage.getItem("userId"))return f("Cannot load history: User not logged in."),void i([]);m(!0),f(""),d(null),i([]);try{const e=await(0,s.OW)();i(e.data||[])}catch(r){var e,t,o;console.error("Error fetching sessions:",r),f((null===(e=r.response)||void 0===e||null===(t=e.data)||void 0===t?void 0:t.message)||"Failed to load chat history sessions."),i([]),401===(null===(o=r.response)||void 0===o?void 0:o.status)&&(console.warn("HistoryModal: Received 401 fetching sessions."),n())}finally{m(!1)}})()}else i([]),d(null),f(""),m(!1),g(!1)}),[t,n]);const x=async e=>{if(localStorage.getItem("userId")){if(e&&!p&&(null===l||void 0===l?void 0:l.sessionId)!==e){g(!0),f("");try{const t=await(0,s.Pt)(e);d(t.data)}catch(a){var t,o,r;console.error("Error fetching session ".concat(e,":"),a),f((null===(t=a.response)||void 0===t||null===(o=t.data)||void 0===o?void 0:o.message)||"Failed to load details for session ".concat(e,".")),d(null),401===(null===(r=a.response)||void 0===r?void 0:r.status)&&(console.warn("HistoryModal: Received 401 fetching session details."),n())}finally{g(!1)}}}else f("Cannot load session details: User not logged in.")},v=e=>{if(!e)return"N/A";try{const t=new Date(e);if(isNaN(t.getTime()))throw new Error("Invalid date string");return t.toLocaleString(void 0,{dateStyle:"short",timeStyle:"short"})}catch(t){return console.warn("Error formatting date:",e,t),e}};return t?(0,c.jsx)("div",{className:"history-modal-overlay",onClick:n,children:(0,c.jsxs)("div",{className:"history-modal-content",onClick:e=>e.stopPropagation(),children:[(0,c.jsx)("button",{className:"history-modal-close-btn",onClick:n,"aria-label":"Close history",children:"\xd7"}),(0,c.jsx)("h2",{children:"Chat History"}),h&&!p&&!u&&(0,c.jsx)("div",{className:"history-error",children:h}),(0,c.jsxs)("div",{className:"history-layout",children:[(0,c.jsxs)("div",{className:"history-session-list",children:[(0,c.jsx)("h3",{children:"Sessions"}),u?(0,c.jsx)("p",{className:"history-loading",children:"Loading sessions..."}):0!==r.length||h?(0,c.jsx)("ul",{children:r.map((e=>(0,c.jsxs)("li",{className:(null===l||void 0===l?void 0:l.sessionId)===e.sessionId?"active":"",onClick:()=>x(e.sessionId),tabIndex:0,onKeyDown:t=>("Enter"===t.key||" "===t.key)&&x(e.sessionId),role:"button",children:[(0,c.jsx)("div",{className:"session-preview",title:e.preview||"Chat session",children:e.preview||"Chat session"}),(0,c.jsxs)("div",{className:"session-date",children:[v(e.updatedAt||e.createdAt)," (",e.messageCount||0," msgs)"]})]},e.sessionId)))}):(0,c.jsx)("p",{className:"history-empty",children:"No past sessions found."})]}),(0,c.jsxs)("div",{className:"history-session-details",children:[(0,c.jsx)("h3",{children:"Session Details"}),p?(0,c.jsx)("p",{className:"history-loading",children:"Loading details..."}):l?(0,c.jsx)("div",{className:"history-messages-area",children:l.messages&&l.messages.length>0?l.messages.map(((e,t)=>{var n,o;return null!==e&&void 0!==e&&e.role&&null!==e&&void 0!==e&&null!==(n=e.parts)&&void 0!==n&&n.length?(0,c.jsxs)("div",{className:"history-message ".concat(e.role),children:[(0,c.jsx)("div",{className:"history-message-content",children:(0,c.jsx)(a.oz,{children:(null===(o=e.parts[0])||void 0===o?void 0:o.text)||""})}),(0,c.jsx)("span",{className:"history-message-timestamp",children:v(e.timestamp)})]},"".concat(l.sessionId,"-").concat(t)):(0,c.jsx)("div",{className:"history-message-error",children:"Invalid message data"},"".concat(l.sessionId,"-err-").concat(t))})):(0,c.jsx)("p",{className:"history-empty",children:"This session appears to have no messages."})}):(0,c.jsx)("p",{className:"history-empty",children:"Select a session from the left to view its messages."})]})]})]})}):null},h=e=>{let{onUploadSuccess:t}=e;const[n,r]=(0,o.useState)(null),[a,i]=(0,o.useState)(""),[l,d]=(0,o.useState)(""),u=(0,o.useRef)(null),m=".pdf,.txt,.docx,.doc,.pptx,.ppt,.py,.js,.bmp,.png,.jpg,.jpeg";return(0,c.jsxs)("div",{className:"file-upload-widget",children:[(0,c.jsx)("h4",{children:"Upload File"}),(0,c.jsx)("input",{type:"file",ref:u,onChange:e=>{const t=e.target.files[0];if(t){const e="."+t.name.split(".").pop().toLowerCase();if(!m.includes(e))return d("Error: File type (".concat(e,") not allowed.")),i("error"),r(null),void(u.current&&(u.current.value=""));const n=20,o=1024*n*1024;if(t.size>o)return d("Error: File exceeds ".concat(n,"MB limit.")),i("error"),r(null),void(u.current&&(u.current.value=""));r(t),d("Selected: ".concat(t.name)),i("")}},accept:m,style:{display:"none"},"aria-hidden":"true"}),(0,c.jsx)("button",{type:"button",className:"select-file-btn",onClick:()=>{var e;null===(e=u.current)||void 0===e||e.click()},disabled:"uploading"===a,children:"Choose File"}),(0,c.jsx)("div",{className:"status-message ".concat(a),children:l||"No file selected."}),(0,c.jsx)("button",{type:"button",className:"upload-btn",onClick:async()=>{if(!n)return d("Please select a file first."),void i("error");if(!localStorage.getItem("userId"))return d("Error: Not logged in. Cannot upload file."),void i("error");i("uploading"),d("Uploading ".concat(n.name,"..."));const e=new FormData;e.append("file",n);try{const n=await(0,s.QM)(e);i("success"),d(n.data.message||"Upload successful!"),console.log("Upload successful:",n.data),r(null),u.current&&(u.current.value=""),t&&"function"===typeof t&&t(),setTimeout((()=>{i((e=>"success"===e?"":e)),d((e=>e===(n.data.message||"Upload successful!")?"":e))}),4e3)}catch(c){var o,a,l;console.error("Upload Error:",c.response||c),i("error"),d((null===(o=c.response)||void 0===o||null===(a=o.data)||void 0===a?void 0:a.message)||"Upload failed. Please check the file or try again."),401===(null===(l=c.response)||void 0===l?void 0:l.status)&&console.warn("FileUpload: Received 401 during upload.")}},disabled:!n||"uploading"===a,children:"uploading"===a?"Uploading...":"Upload"})]})},f=e=>{switch(e){case"docs":return"\ud83d\udcc4";case"images":return"\ud83d\uddbc\ufe0f";case"code":return"\ud83d\udcbb";default:return"\ud83d\udcc1"}},x=e=>{if(0===e)return"0 Bytes";const t=["Bytes","KB","MB","GB","TB"];if("number"!==typeof e||e<0)return"N/A";const n=Math.floor(Math.log(e)/Math.log(1024)),o=Math.max(0,Math.min(n,t.length-1));return parseFloat((e/Math.pow(1024,o)).toFixed(1))+" "+t[o]},v="file-manager-widget-styles";if(!document.getElementById(v)){const e=document.createElement("style");e.id=v,e.type="text/css",e.innerText="\n/* client/src/components/FileManagerWidget.css */\n.file-manager-widget { display: flex; flex-direction: column; gap: 10px; padding: 15px 0px 15px 20px; box-sizing: border-box; height: 100%; overflow: hidden; }\n.fm-header { display: flex; justify-content: space-between; align-items: center; padding-right: 20px; flex-shrink: 0; }\n.file-manager-widget h4 { margin: 0; color: var(--text-primary); font-size: 0.95rem; font-weight: 600; }\n.fm-refresh-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; line-height: 1; transition: color 0.2s, border-color 0.2s, background-color 0.2s; }\n.fm-refresh-btn:hover:not(:disabled) { color: var(--text-primary); border-color: #555; background-color: #3a3a40; }\n.fm-refresh-btn:disabled { cursor: not-allowed; opacity: 0.5; }\n.fm-error, .fm-loading, .fm-empty { font-size: 0.85rem; padding: 10px 15px; border-radius: 4px; text-align: center; margin: 5px 20px 5px 0; flex-shrink: 0; }\n.fm-error { color: var(--error-color); border: 1px solid var(--error-color); background-color: var(--error-bg); }\n.fm-loading, .fm-empty { color: var(--text-secondary); font-style: italic; }\n.fm-loading-bottom { margin-top: auto; padding: 5px; }\n.fm-file-list-container { flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-right: 10px; position: relative; }\n.fm-file-list-container::-webkit-scrollbar { width: 8px; }\n.fm-file-list-container::-webkit-scrollbar-track { background: transparent; }\n.fm-file-list-container::-webkit-scrollbar-thumb { background-color: #4a4a50; border-radius: 10px; }\n.fm-file-list-container { scrollbar-width: thin; scrollbar-color: #4a4a50 transparent; }\n.fm-file-list { list-style: none; padding: 0; margin: 0; }\n.fm-file-item { display: flex; align-items: center; padding: 8px 5px; margin-bottom: 5px; border-radius: 4px; background-color: #2f2f34; transition: background-color 0.2s ease; gap: 10px; }\n.fm-file-item:hover { background-color: #3a3a40; }\n.fm-file-icon { flex-shrink: 0; font-size: 1.1rem; line-height: 1; }\n.fm-file-details { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; min-height: 30px; }\n.fm-file-name { font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n.fm-file-size { font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px; }\n.fm-file-actions { display: flex; gap: 5px; flex-shrink: 0; margin-left: auto; }\n.fm-action-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 3px; font-size: 1rem; line-height: 1; border-radius: 3px; transition: color 0.2s ease, background-color 0.2s ease; }\n.fm-action-btn:hover:not(:disabled) { color: var(--text-primary); background-color: #4a4a50; }\n.fm-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }\n.fm-delete-btn:hover:not(:disabled) { color: var(--error-color); }\n.fm-rename-btn:hover:not(:disabled) { color: var(--accent-blue-light); }\n.fm-save-btn:hover:not(:disabled) { color: #52c41a; } /* Green */\n.fm-cancel-btn:hover:not(:disabled) { color: #ffc107; } /* Orange/Yellow */\n.fm-rename-section { display: flex; align-items: center; gap: 5px; width: 100%; }\n.fm-rename-input { flex-grow: 1; padding: 4px 8px; background-color: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85rem; outline: none; min-width: 50px; }\n.fm-rename-input:focus { border-color: var(--accent-blue); }\n",document.head.appendChild(e)}const b=e=>{let{refreshTrigger:t}=e;const[n,r]=(0,o.useState)([]),[a,i]=(0,o.useState)(!1),[l,d]=(0,o.useState)(""),[u,m]=(0,o.useState)(null),[p,g]=(0,o.useState)(""),h=(0,o.useCallback)((async()=>{if(!localStorage.getItem("userId"))return console.log("FileManager: Skipping fetch, no userId."),void r([]);i(!0),d("");try{const e=await(0,s.DA)();r(e.data||[])}catch(o){var e,t,n;console.error("Error fetching user files:",o),d((null===(e=o.response)||void 0===e||null===(t=e.data)||void 0===t?void 0:t.message)||"Failed to load files."),r([]),401===(null===(n=o.response)||void 0===n?void 0:n.status)&&console.warn("FileManager: Received 401, potential logout needed.")}finally{i(!1)}}),[]);(0,o.useEffect)((()=>{h()}),[t,h]);const v=()=>{m(null),g(""),d("")},b=async()=>{if(u&&p.trim())if(p.includes("/")||p.includes("\\"))d("New name cannot contain slashes.");else{i(!0),d("");try{await(0,s.Mk)(u,p.trim()),m(null),g(""),h()}catch(o){var e,t,n;console.error("Error renaming file:",o),d((null===(e=o.response)||void 0===e||null===(t=e.data)||void 0===t?void 0:t.message)||"Failed to rename file."),401===(null===(n=o.response)||void 0===n?void 0:n.status)&&console.warn("FileManager: Received 401 during rename.")}finally{i(!1)}}else d("New name cannot be empty.")},y=e=>{"Enter"===e.key?b():"Escape"===e.key&&v()};return(0,c.jsxs)("div",{className:"file-manager-widget",children:[(0,c.jsxs)("div",{className:"fm-header",children:[(0,c.jsx)("h4",{children:"Your Uploaded Files"}),(0,c.jsx)("button",{onClick:h,disabled:a,className:"fm-refresh-btn",title:"Refresh File List",children:"\ud83d\udd04"})]}),l&&(0,c.jsx)("div",{className:"fm-error",children:l}),(0,c.jsxs)("div",{className:"fm-file-list-container",children:[a&&0===n.length?(0,c.jsx)("p",{className:"fm-loading",children:"Loading files..."}):0!==n.length||a?(0,c.jsx)("ul",{className:"fm-file-list",children:n.map((e=>(0,c.jsxs)("li",{className:"fm-file-item",children:[(0,c.jsx)("span",{className:"fm-file-icon",children:f(e.type)}),(0,c.jsx)("div",{className:"fm-file-details",children:u===e.serverFilename?(0,c.jsxs)("div",{className:"fm-rename-section",children:[(0,c.jsx)("input",{type:"text",value:p,onChange:e=>g(e.target.value),onKeyDown:y,autoFocus:!0,className:"fm-rename-input","aria-label":"New name for ".concat(e.originalName)}),(0,c.jsx)("button",{onClick:b,disabled:a||!p.trim(),className:"fm-action-btn fm-save-btn",title:"Save Name",children:"\u2714\ufe0f"}),(0,c.jsx)("button",{onClick:v,disabled:a,className:"fm-action-btn fm-cancel-btn",title:"Cancel Rename",children:"\u274c"})]}):(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("span",{className:"fm-file-name",title:e.originalName,children:e.originalName}),(0,c.jsx)("span",{className:"fm-file-size",children:x(e.size)})]})}),u!==e.serverFilename&&(0,c.jsxs)("div",{className:"fm-file-actions",children:[(0,c.jsx)("button",{onClick:()=>(e=>{m(e.serverFilename),g(e.originalName),d("")})(e),disabled:a||!!u,className:"fm-action-btn fm-rename-btn",title:"Rename",children:"\u270f\ufe0f"}),(0,c.jsx)("button",{onClick:()=>(async(e,t)=>{if(window.confirm('Are you sure you want to delete "'.concat(t,'"? This cannot be undone.'))){i(!0),d("");try{await(0,s.bW)(e),h()}catch(a){var n,o,r;console.error("Error deleting file:",a),d((null===(n=a.response)||void 0===n||null===(o=n.data)||void 0===o?void 0:o.message)||"Failed to delete file."),401===(null===(r=a.response)||void 0===r?void 0:r.status)&&console.warn("FileManager: Received 401 during delete.")}finally{i(!1)}}})(e.serverFilename,e.originalName),disabled:a||!!u,className:"fm-action-btn fm-delete-btn",title:"Delete",children:"\ud83d\uddd1\ufe0f"})]})]},e.serverFilename)))}):(0,c.jsx)("p",{className:"fm-empty",children:"No files uploaded yet."}),a&&n.length>0&&(0,c.jsx)("p",{className:"fm-loading fm-loading-bottom",children:"Processing..."})]})]})};var y=n(722);const w=e=>{let{onTranscript:t,userId:n}=e;const[r,s]=(0,o.useState)(!1),[a,i]=(0,o.useState)(""),[l,d]=(0,o.useState)(null),[u,m]=(0,o.useState)(!1),[p,g]=(0,o.useState)(0),[h,f]=(0,o.useState)(!1),[x,v]=(0,o.useState)("disconnected"),b=(0,o.useRef)(null),w=(0,o.useRef)(null),j=(0,o.useRef)(0),S=(0,o.useRef)(!0),k=(0,o.useCallback)((()=>{if(!S.current||!n)return console.log("Cannot setup recognition: component unmounted or no user"),null;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)return d("Speech Recognition API is not supported in this browser. Please use Chrome or Edge."),null;N();const o=new e;return o.continuous=!0,o.interimResults=!0,o.lang="en-US",o.onstart=()=>{S.current&&(console.log("Recognition started"),v("connected"),d(null),j.current=0)},o.onresult=async e=>{if(!S.current)return;let o="",r="";for(let t=e.resultIndex;t<e.results.length;t++){const n=e.results[t][0].transcript;e.results[t].isFinal?r+=n:o+=n}if(i(r+o),r)try{m(!0);const e=await y.A.post("http://localhost:5001/api/speech",{text:r},{headers:{"Content-Type":"application/json","X-User-ID":n},timeout:5e3});t&&t(r,e.data)}catch(l){var s,a;if(console.error("Error processing transcript:",l),"ECONNABORTED"===l.code)d("Request timed out. Please try again.");else d((null===(s=l.response)||void 0===s||null===(a=s.data)||void 0===a?void 0:a.error)||"Failed to process speech. Please try again.")}finally{m(!1)}},o.onerror=e=>{if(!S.current)return;console.error("Speech recognition error:",e.error);let t="",n=!1,o=1e3;switch(e.error){case"network":p>=2?(t="Network error occurred. Please try again later.",n=!1,s(!1),N()):(t="Network error occurred. Retrying...",n=!0,o=500),v("error");break;case"aborted":j.current+=1,j.current>=1?(t="Speech recognition was interrupted. Please try again.",n=!1,s(!1),N()):(t="Speech recognition was interrupted. Retrying...",n=!0,o=300),v("error");break;case"not-allowed":t="Microphone access was denied. Please allow microphone access and try again.",v("error");break;case"audio-capture":t="No microphone was found. Please ensure a microphone is connected.",v("error");break;case"no-speech":t="No speech was detected. Please try speaking again.",n=!0;break;case"service-not-allowed":t="Speech recognition service is not allowed. Please check your browser settings.",v("error");break;default:t="Speech recognition error: ".concat(e.error,". Please try again."),n=p<2,v("error")}d(t),n&&r&&S.current?(g((e=>e+1)),v("connecting"),C(),w.current=setTimeout((()=>{r&&!h&&S.current&&(E()?d("Reconnecting..."):(d("Failed to reconnect. Please try again."),s(!1),N()))}),o)):n||(s(!1),N())},o.onend=()=>{S.current&&(console.log("Recognition ended"),f(!1),r&&S.current?p<2&&j.current<1?(v("connecting"),C(),w.current=setTimeout((()=>{r&&!h&&S.current&&(E()||(d("Failed to restart speech recognition. Please try again."),s(!1),N()))}),1e3)):(d("Maximum retry attempts reached. Please try again."),s(!1),N()):v("disconnected"))},o}),[r,t,n,p,h,N,E]),N=(0,o.useCallback)((()=>{if(console.log("Cleaning up speech recognition..."),w.current&&(clearTimeout(w.current),w.current=null),b.current){try{b.current.stop()}catch(e){console.warn("Error stopping recognition during cleanup:",e)}b.current=null}f(!1),v("disconnected"),g(0),j.current=0,d(null),i("")}),[]);(0,o.useEffect)((()=>()=>{console.log("Component unmounting, cleaning up..."),S.current=!1,N()}),[N]),(0,o.useEffect)((()=>{n||(console.log("User logged out, cleaning up speech recognition..."),N(),s(!1))}),[n,N]);const C=(0,o.useCallback)((()=>{w.current&&(clearTimeout(w.current),w.current=null)}),[]),I=(0,o.useCallback)((()=>{N()}),[N]),E=(0,o.useCallback)((()=>{if(!S.current||!n)return console.log("Cannot start recognition: component unmounted or no user"),!1;if(!b.current){const e=k();if(!e)return!1;b.current=e}try{return b.current.start(),f(!0),v("connected"),j.current=0,!0}catch(e){return console.error("Error starting recognition:",e),v("error"),f(!1),!1}}),[n,k,C]);(0,o.useEffect)((()=>{if(r){k()&&(v("connecting"),E()||(d("Failed to start speech recognition. Please try again."),s(!1)))}return()=>{C(),I(),g(0),v("disconnected")}}),[r,k,E,I,C]);return(0,c.jsxs)("div",{className:"speech-to-text",children:[(0,c.jsxs)("button",{onClick:()=>{n?r?(N(),s(!1)):(N(),s(!0),g(0),v("connecting")):d("Please log in to use speech recognition")},className:"mic-button ".concat(r?"active":""," ").concat(u?"processing":""," ").concat(x),disabled:u,title:r?"Stop listening":"Start listening",children:[(0,c.jsx)("i",{className:"fas fa-microphone ".concat(r?"fa-beat":"")}),r?" Stop":" Start"," Listening","connecting"===x&&" (Connecting...)"]}),a&&(0,c.jsx)("div",{className:"transcript-container",children:(0,c.jsxs)("p",{className:"transcript",children:[(0,c.jsx)("span",{className:"label",children:"Transcript:"})," ",a]})}),l&&(0,c.jsx)("div",{className:"error-container",children:(0,c.jsxs)("p",{className:"error",children:[(0,c.jsx)("i",{className:"fas fa-exclamation-circle"})," ",l]})})]})},j=e=>{let{currentPreference:t,onPreferenceChange:n}=e;return(0,c.jsxs)("div",{className:"llm-preference-widget",children:[(0,c.jsx)("h3",{children:"AI Model"}),(0,c.jsxs)("select",{className:"llm-select",value:t,onChange:async e=>{const t=e.target.value;try{await(0,s.al)(t),n(t)}catch(o){console.error("Failed to update LLM preference:",o)}},"aria-label":"Select AI Model",children:[(0,c.jsx)("option",{value:"gemini",children:"Gemini (Default)"}),(0,c.jsx)("option",{value:"ollama",children:"Ollama (Local)"})]}),(0,c.jsx)("div",{className:"model-description",children:"gemini"===t?(0,c.jsx)("p",{children:"Using Google's Gemini model for chat responses (recommended)."}):(0,c.jsx)("p",{children:"Using local Ollama model for chat responses (requires Ollama server)."})})]})},S=e=>{let{setIsAuthenticated:t}=e;const[n,m]=(0,o.useState)([]),[f,x]=(0,o.useState)(""),[v,y]=(0,o.useState)(!1),[S,k]=(0,o.useState)(""),[N,C]=(0,o.useState)(""),[I,E]=(0,o.useState)(""),[P,R]=(0,o.useState)(""),[A,F]=(0,o.useState)("friendly"),[T,z]=(0,o.useState)((()=>u("friendly"))),[D,M]=(0,o.useState)(!1),[U,O]=(0,o.useState)(0),[L,B]=(0,o.useState)(!1),[_,H]=(0,o.useState)(!1),[q,G]=(0,o.useState)((()=>"ollama"===localStorage.getItem("llmPreference")?"ollama":"gemini")),K=(0,o.useRef)(null),W=(0,r.Zp)();(0,o.useEffect)((()=>{var e;null===(e=K.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[n]),(0,o.useEffect)((()=>{const e=localStorage.getItem("sessionId"),t=localStorage.getItem("userId"),n=localStorage.getItem("username");t&&e&&n?(console.log("ChatPage Mount: Auth info found. Setting state."),C(e),E(t),R(n)):(console.warn("ChatPage Mount: Missing auth info in localStorage. Redirecting to login."),ee(!0))}),[ee]),(0,o.useEffect)((()=>{I&&(async()=>{const e=localStorage.getItem("userId");if(!e)return console.log("User files check skipped: No userId available."),B(!1),void H(!1);console.log("Checking user files for userId:",e);try{const e=await(0,s.DA)(),t=e.data&&e.data.length>0;B(t),H(t),console.log("User files check successful:",t?"".concat(e.data.length," files found."):"No files found.")}catch(n){var t;console.error("Error checking user files:",n),401!==(null===(t=n.response)||void 0===t?void 0:t.status)||window.location.pathname.includes("/login")?(k("Could not check user files."),B(!1),H(!1)):(console.warn("Received 401 checking files, logging out."),ee(!0))}})()}),[I,U,ee]);const Y=(0,o.useCallback)((()=>O((e=>e+1))),[]),Q=(0,o.useCallback)((e=>{F(e),z(u(e)),k((e=>e&&(e.includes("Session invalid")||e.includes("Critical Error"))?e:"Assistant mode changed.")),setTimeout((()=>{k((e=>"Assistant mode changed."===e?"":e))}),3e3)}),[]),V=(0,o.useCallback)((e=>{z(e);const t=d.find((t=>"custom"!==t.id&&t.prompt===e));F(t?t.id:"custom")}),[]),X=(0,o.useCallback)((()=>M(!0)),[]),Z=(0,o.useCallback)((()=>M(!1)),[]),J=(0,o.useCallback)((e=>{G(e),localStorage.setItem("llmPreference",e),m([]),k("AI model changed. Starting a new conversation."),setTimeout((()=>k("")),3e3)}),[]),$=(0,o.useCallback)((async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const o=localStorage.getItem("sessionId"),r=localStorage.getItem("userId"),a=[...n];if(!o||!r)return console.error("Save Error: Session ID or User ID missing."),k("Critical Error: Session info missing."),void(t&&t());if(v||0===a.length)return void(t&&t());let i=null;y(!0),k((e=>e&&(e.includes("Session invalid")||e.includes("Critical Error"))?e:""));try{console.log("Saving history for session: ".concat(o," (User: ").concat(r,")"));if(i=(await(0,s.qR)({sessionId:o,messages:a})).data.newSessionId,!i)throw new Error("Backend failed to provide new session ID.");localStorage.setItem("sessionId",i),C(i),m([]),e||(Q("friendly"),k("")),console.log("History saved. New session ID: ".concat(i))}catch(p){var c,d,u;const t=(null===(c=p.response)||void 0===c||null===(d=c.data)||void 0===d?void 0:d.message)||p.message||"Failed to save/reset session.";console.error("Save/Reset Error:",p.response||p),k("Session Error: ".concat(t)),401!==(null===(u=p.response)||void 0===u?void 0:u.status)||e?i||e?e&&!i&&console.error("Save failed during logout."):(i=(0,l.A)(),localStorage.setItem("sessionId",i),C(i),m([]),Q("friendly"),console.warn("Save failed, generated new client-side session ID:",i)):(console.warn("Received 401 saving history, logging out."),ee(!0))}finally{y(!1),t&&t()}}),[n,v,Q,ee]),ee=(0,o.useCallback)((function(){const e=()=>{console.log("Performing logout cleanup..."),localStorage.clear(),t(!1),m([]),C(""),E(""),R(""),F("friendly"),z(u("friendly")),k(""),B(!1),H(!1),requestAnimationFrame((()=>{"/login"!==window.location.pathname&&W("/login",{replace:!0})}))};!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&n.length>0?$(!0,e):e()}),[W,t,$,n.length]),te=(0,o.useCallback)((()=>{v||$(!1)}),[v,$]),ne=(0,o.useCallback)((async e=>{if(e&&e.preventDefault&&e.preventDefault(),!f.trim()||v)return;const t={id:(0,l.A)(),text:f,sender:"user",timestamp:(new Date).toISOString()};m((e=>[...e,t])),x(""),y(!0),k("");try{const e=await(0,s._z)(f,N,n.map((e=>({role:e.sender,content:e.text}))),q),t={id:(0,l.A)(),text:e.message,sender:"ai",timestamp:(new Date).toISOString()};m((e=>[...e,t]))}catch(a){var o,r;console.error("Error sending message:",a),k((null===(o=a.response)||void 0===o||null===(r=o.data)||void 0===r?void 0:r.message)||"Failed to send message. Please try again.")}finally{y(!1)}}),[f,v,N,n,q,m,x,y,k]),oe=(0,o.useCallback)((e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),ne())}),[ne]),re=(0,o.useCallback)((async(e,t)=>{var n,o,r;e&&(x(e),null!==t&&void 0!==t&&null!==(n=t.chatResponse)&&void 0!==n&&n.role&&(null===t||void 0===t||null===(o=t.chatResponse)||void 0===o||null===(r=o.parts)||void 0===r?void 0:r.length)>0&&m((e=>[...e,t.chatResponse])),await ne())}),[ne]),se=v;return I?(0,c.jsxs)("div",{className:"chat-page-container",children:[(0,c.jsxs)("div",{className:"sidebar-area",children:[(0,c.jsx)(j,{currentPreference:q,onPreferenceChange:J}),(0,c.jsx)(p,{selectedPromptId:A,promptText:T,onSelectChange:Q,onTextChange:V}),(0,c.jsx)(h,{onUploadSuccess:Y}),(0,c.jsx)(b,{refreshTrigger:U}),(0,c.jsx)(w,{onTranscript:re,userId:I})]}),(0,c.jsxs)("div",{className:"chat-container",children:[(0,c.jsxs)("header",{className:"chat-header",children:[(0,c.jsx)("h1",{children:"Engineering Tutor"}),(0,c.jsxs)("div",{className:"header-controls",children:[(0,c.jsxs)("span",{className:"username-display",children:["Hi, ",P,"!"]}),(0,c.jsx)("button",{onClick:X,className:"header-button history-button",disabled:se,children:"History"}),(0,c.jsx)("button",{onClick:te,className:"header-button newchat-button",disabled:se,children:"New Chat"}),(0,c.jsx)("button",{onClick:()=>ee(!1),className:"header-button logout-button",disabled:se,children:"Logout"})]})]}),(0,c.jsxs)("div",{className:"messages-area",children:[n.map(((e,t)=>{var n,o;if(null===e||void 0===e||!e.role||null===e||void 0===e||null===(n=e.parts)||void 0===n||!n.length||!e.timestamp)return console.warn("Rendering invalid message structure at index",t,e),(0,c.jsx)("div",{className:"message-error",children:"Msg Error"},"error-".concat(t));const r=(null===(o=e.parts[0])||void 0===o?void 0:o.text)||"";return(0,c.jsxs)("div",{className:"message ".concat(e.role),children:[(0,c.jsx)("div",{className:"message-content",children:(0,c.jsx)(a.oz,{remarkPlugins:[i.A],children:r})}),(0,c.jsx)("span",{className:"message-timestamp",children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]},"".concat(N,"-").concat(t))})),(0,c.jsx)("div",{ref:K})]}),se&&(0,c.jsx)("div",{className:"loading-indicator",children:(0,c.jsx)("span",{children:_?"Searching documents...":"Thinking..."})}),!se&&S&&(0,c.jsx)("div",{className:"error-indicator",children:S}),(0,c.jsxs)("footer",{className:"input-area",children:[(0,c.jsx)("textarea",{value:f,onChange:e=>x(e.target.value),onKeyDown:oe,placeholder:"Ask your tutor...",rows:"1",disabled:se,"aria-label":"Chat input"}),(0,c.jsxs)("div",{className:"rag-toggle-container",title:L?_?"Disable RAG":"Enable RAG":"Upload files to enable RAG",children:[(0,c.jsx)("input",{type:"checkbox",id:"rag-toggle",checked:_,onChange:e=>{H(e.target.checked)},disabled:!L||se,"aria-label":"Enable RAG"}),(0,c.jsx)("label",{htmlFor:"rag-toggle",children:"RAG"})]}),(0,c.jsx)("button",{onClick:ne,disabled:se||!f.trim(),title:"Send Message","aria-label":"Send message",children:(0,c.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"20",height:"20",children:(0,c.jsx)("path",{d:"M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"})})})]})]}),(0,c.jsx)(g,{isOpen:D,onClose:Z})]}):(0,c.jsx)("div",{className:"loading-indicator",children:(0,c.jsx)("span",{children:"Initializing..."})})}}}]);
//# sourceMappingURL=717.784c02c8.chunk.js.map